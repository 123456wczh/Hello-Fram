# Code Farm: The Algorithm Age - 开发者开发与维护指南 (Developer Guide)

欢迎阅读 **Code Farm** 的核心开发文档。
这份文档专为开发者设计，旨在让你在 **10分钟内** 理解整个项目架构，并能立即着手添加新功能。

---

## 🏗️ 1. 架构总览 (System Architecture)

Code Farm 是一个基于 **Python 3.13** 和 **pygame-ce** 的编程模拟游戏。
其核心设计理念是：**将 Python 解释器（Exec）嵌入到游戏循环中**，通过沙盒 API 控制游戏实体。

### 核心循环 (Core Loop)
1.  **入口 (Entry)**: `src/main.py` -> 实例化 `GameIDE`。
2.  **主循环 (Game Loop)**: `src/ui/ide.py` 中的 `run()` 方法。
    *   **事件 (Events)**: `pygame` 事件 -> 分发给 `ui_manager` (GUI) 和 `editor_windows` (编辑器)。
    *   **更新 (Update)**: `Farm.update()` (作物生长) -> `Drone.update()` (无人机动作) -> `Cutscene.update()` (剧情检测)。
    *   **渲染 (Render)**: 先画农场 (`draw_game_area`) -> 再画 UI (`ui_manager.draw_ui`)。

---

## 📂 2. 文件详解 (File by File Documentation)

我们根据功能模块对文件进行了详细解析。

### 核心与配置 (Root & Config)
| 文件 | 职责说明 | 修改频率 |
| :--- | :--- | :--- |
| `src/main.py` | **启动入口**。仅负责初始化 `GameIDE` 并调用 `run()`。 | 极低 |
| `src/config.py` | **全局配置**。屏幕分辨率、网格大小 (`GRID_SIZE`)、颜色表 (`COLORS`)。若要调整窗口大小或UI配色，请改这里。 | 低 |

### 核心逻辑 (Core Logic) - `src/core/`
| 文件 | 职责说明 | 关键类/函数 |
| :--- | :--- | :--- |
| `farm.py` | **农场数据模型**。维护 `self.grid` (2D数组)。处理作物生长、枯萎、耕地状态。不涉及任何渲染代码。 | `Farm` |
| `api.py` | **无人机 API (沙盒接口)**。这是**暴露给用户代码**的接口。用户调用的 `drone.move()` 实际上是这里的方法。包含指令队列和动画延迟逻辑。 | `DroneAPI` |
| `skills.py` | **技能与科技树**。定义技能树结构 (`SKILL_TREE`) 以及解锁逻辑 (`unlock`)。 | `SkillManager` |
| `storage.py` | **存档与文件系统**。负责 `savegame.json` (农场状态) 的读写，以及初始化 `user_scripts/` 目录。 | `SaveManager` |

### 实体定义 (Entities) - `src/entities/`
| 文件 | 职责说明 | 关键点 |
| :--- | :--- | :--- |
| `crops.py` | **作物定义工厂**。所有作物的属性（生长时间、价值、特殊逻辑）都在这里定义。包含 `CROP_FACTORY` 映射表。 | `Crop`, `Pumpkin`, `CROP_FACTORY` |

### 用户界面 (UI) - `src/ui/`
| 文件 | 职责说明 | 深度解析 |
| :--- | :--- | :--- |
| `ide.py` | **IDE 主控中心**。**最复杂的文件**。包含主游戏循环、事件分发、代码执行线程 (`exec`调用处)、`aux_windows` (弹窗) 管理。 | `GameIDE.run()`, `run_user_code()` |
| `windows.py` | **UI 窗口组件**。定义了代码编辑器 (`CodeEditorWindow`)、文件浏览器 (`FileBrowserWindow`)、技能树窗口等所有悬浮窗。 | `CodeEditorWindow` |
| `cutscene.py` | **剧情与导引系统**。管理新手教程的步骤 (`step 1..15`) 和底部对话框的渲染。 | `CutsceneManager` |
| `visuals.py` | **视觉效果管理器**。资源加载 (`load_assets`)、粒子效果 (收割时的火花)、缓动动画 (`Tween`)。 | `VisualManager` |

### 工具类 (Utils) - `src/utils/`
| 文件 | 职责说明 |
| :--- | :--- |
| `highlighter.py` | **语法高亮**。使用正则解析 Python 代码并生成 Pygame 富文本颜色标签。 |
| `sound_generator.py` | **音效生成**。实时生成 8-bit 风格音效 (Bip/Bop)，无需 mp3 文件。 |
| `asset_generator.py` | **美术生成**。如果 `assets/` 缺图，会自动生成像素风占位图。 |

---

## 🛠️ 3. 接下来继续开发的代码级指示 (Detailed Dev Roadmap)

以下是为您准备的 **"精确到行"** 的开发指南，请在后续开发中严格参考。

### ✅ 任务 A: 添加新作物 "Corn" (玉米)
**目标**: 添加一种高价值作物，生长慢，但无需特殊机制。

**步骤 1: 修改 `src/entities/crops.py`**
在 `Sunflower` 类之后 (约第 124 行)，插入以下代码：

```python
class Corn(Crop):
    def __init__(self):
        # 参数: 名称="Corn", 生长时间=12秒, 价值=80
        super().__init__("Corn", 12.0, 80)
```

**步骤 2: 注册到工厂**
在 `src/entities/crops.py` 的 `CROP_FACTORY` 字典中 (约第 130 行) 添加：

```python
CROP_FACTORY = {
    "carrot": Carrot,
    "pumpkin": Pumpkin,
    "blueberry": Blueberry,
    "sunflower": Sunflower,
    "corn": Corn, # <--- 新行
}
```

**步骤 3: 准备贴图**
确保 `assets/` 目录下有 `crop_corn_stage1.png` 到 `crop_corn_stage4.png`。如果没有，`VisualManager` 会自动生成带文字的红块，不会报错。

---

### ✅ 任务 B: 添加由 "Corn" 解锁的新技能

**步骤 1: 修改 `src/core/skills.py`**
在 `SKILL_TREE` 字典中 (约第 15 行) 添加新节点：

```python
    "seed_corn": {
        "name": "Corn Seeds",
        "cost": {"carrot": 50, "pumpkin": 10}, # 需要 50胡萝卜 + 10南瓜
        "description": "Unlocks high-yield Corn seeds.",
        "icon": "icon_corn",
        "unlocks": "corn", # 解锁 API 里的 plant('corn') 权限
        "parent": "seed_pumpkin" # UI上连线到南瓜
    },
```

---

### ✅ 任务 C: 添加新 UI 窗口 (例如 "统计面板")

**步骤 1: 修改 `src/ui/windows.py`**
在文件末尾添加新类：

```python
class StatsWindow(BaseModal):
    def __init__(self, manager, farm_ref):
        super().__init__(manager, "Farm Stats", 300, 200)
        self.farm = farm_ref
        
        self.txt_info = pygame_gui.elements.UITextBox(
            html_text=f"Total Plots: {self.farm.width * self.farm.height}",
            relative_rect=pygame.Rect((10, 10), (280, 150)),
            manager=manager,
            container=self.window
        )
```

**步骤 2: 修改 `src/ui/ide.py` 挂载窗口**
1. 在 `__init__` (约第 89 行) 注册: `self.windows['stats'] = StatsWindow(...)`。
2. 在 `_init_ui_elements` (约第 220 行) 添加按钮: `self.btn_stats = ...`。
3. 在 `handle_event` (约第 500 行) 添加按钮响应: `self.windows['stats'].show()`。

---

## ⚠️ 常见问题修复

*   **报错 `ReferenceError` 或按钮点击无反应**：
    *   检查 `ide.py` 的 `UI_BUTTON_PRESSED` 事件循环。
    *   如果是新弹窗 (`BaseModal` 子类)，**必须**把它加入 `self.aux_windows` 列表 (在 `ide.py` 中)，否则它收不到事件！

*   **存档丢失**：
    *   用户代码位于 `user_scripts/*.py`。
    *   游戏进度 (金币/技能) 位于 `savegame.json`。
    *   二者是分离的。

---
*Generated by Antigravity Agent - 2025-12-29*
