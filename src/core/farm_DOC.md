# 农场逻辑文档 (Documentation for farm.py)

**文件位置**: `src/core/farm.py`
**功能**: 核心业务逻辑类。维护 2D 网格数据，处理种植、收割、生长循环以及复杂的“南瓜融合”机制。无任何渲染代码。

## 📜 代码逐行解析

| 行号范围 | 代码内容 | 解析与说明 |
| :--- | :--- | :--- |
| **1-10** | **初始化** | 导入 `GRID_WIDTH` (10x10)。`self.grid` 是一个二维列表，存储 `Crop` 对象或 `None`。这是游戏状态的“真理来源”。 |
| **11-18** | `plant_crop` | **种植逻辑**。检查边界 (`0<=x<width`) 和空位 (`is None`)。这是原子操作，被 API 调用。 |
| **19-40** | `harvest_crop` | **收割逻辑**。**亮点**：如果点击的是 `OccupiedSlot` (大型南瓜的附属格)，代码会自动重定向到其父节点 (`parent`) 进行判定。只有 `is_ready` 为 True 才能收割。 |
| **41-60** | `destroy_crop` | **强制销毁**。用于清理未成熟或腐烂的作物。同样支持 `OccupiedSlot` 的重定向处理。 |
| **62-72** | `remove_crop` | **清理助手**。如果是清除大型南瓜 (`size > 1`)，会遍历整个 N*N 区域将所有格子置为 `None`。 |
| **84-292** | `check_fusion` | **核心算法：无限融合**。这是最复杂的函数。<br>1. 遍历每个格子。<br>2. 从最大可能的尺寸 K 开始递减扫描 (`range(limit, 1, -1)`)。<br>3. **完整性检查**：确保选中区域内的所有格子都是有效的南瓜，且没有“切断”其他现有的大型南瓜。<br>4. **耐心检查**：如果周围有正在生长的未成熟南瓜，则暂停融合（等待它们成熟以便融合更大的）。<br>5. 如果通过检查，调用 `fuse_pumpkins`。 |
| **293-302** | `fuse_pumpkins` | **融合执行**。在 (x,y) 放置一个新的 Level N 的南瓜，周围填充 `OccupiedSlot` 指向它。 |
| **303-319** | `to_dict` | **序列化**。将网格转换为 JSON 友好的嵌套列表字典。 |
| **321-370** | `load_from_data` | **反序列化**。分两步加载：<br>1. 加载所有主作物。<br>2. 遍历网格，如果发现大型南瓜，自动重建周围的 `OccupiedSlot`。这比保存所有 slot 数据更稳健。 |

## 🛠️ 维护与扩展指南

### 如何修改融合规则？
*   **修改融合概率**：目前是 100% 融合。如果想要随机融合，可以在 `check_fusion` 的第 256 行附近添加 `if random.random() < 0.5: continue`。
*   **修改耐心机制**：注释掉 228-246 行的代码，南瓜就会变得贪婪（一成熟就融合，不再等待邻居）。

### 性能优化
*   `check_fusion` 每帧调用 (`update` 中)。对于 10x10 网格，当前算法性能足够。如果扩大到 100x100，需要改为“脏标记”模式（仅当有作物成熟时检查）。
